async function processGPXAsync(n){let i=[];if(!n.name.endsWith(".gpx")){alert("Only gpx file type is allowed.");return}showSpinner();let r=await readFile(n),t=r.match(/((<trkpt)|(<rtept)) \w+=\"[0-9]+\.[0-9]+\" \w+=\"[0-9]+\.[0-9]+\"/gm),u=r.match(/<ele>[0-9]+.[0-9]+<\/ele>/gm);if(t===null||t.length===0){alert("File does not contain any coordinates.");hideSpinner();return}for(let n=0;n<t.length;n++){let e=t[n],f=e.match(/([\d.]+)/g),o=u[n].match(/([\d.]+)/g),r=[],s=parseFloat(f[0]),h=parseFloat(f[1]),c=parseFloat(o);r.push(s);r.push(h);r.push(c);i.push(r)}return hideSpinner(),i}function readFile(n){return new Promise((t,i)=>{const r=new FileReader;r.onload=n=>{t(n.target.result)};r.onerror=n=>i(n);r.readAsText(n)})}function drawImportedRoute(n){editableLayers.eachLayer(function(n){editableLayers.removeLayer(n)});isUploadButtonClicked=!0;importedRouteTotalLength=0;minAltitude=0;maxAltitude=0;importedRoutePoints.length=0;yAxisChartData.length=0;xAxisChartData.length=0;altitudes.length=0;let u=L.layerGroup(),i=[];for(let t=0;t<n.length;t++){let r=n[t];i.push(new L.LatLng(r[0],r[1],r[2]));let u=r[2].toFixed(2);altitudes.push(u);t%250==0&&yAxisChartData.push(u)}minAltitude=Math.min(...altitudes);maxAltitude=Math.max(...altitudes);let r=new L.Polyline(i,{color:"#c700ac",weight:4,smoothFactor:1,fillOpacity:.5});importedRoutePoints=r.getLatLngs().map(n=>[n.lat,n.lng,n.alt]);let t=r.getLatLngs();for(let n=0;n<t.length-1;n++)importedRouteTotalLength+=t[n].distanceTo(t[n+1]);let f=0;for(let n=0;n<t.length-1;n++)f+=t[n].distanceTo(t[n+1]),n%250==0&&xAxisChartData.push(`${(f/1e3).toFixed(2)} km`);importedRouteTotalLength/=1e3;r.bindPopup(`Event route is ${importedRouteTotalLength.toFixed(2)} kilometers long.`);u.addLayer(r);setupRouteIcons(i[0],i[i.length-1],r,u);let e=document.getElementById("line-chart");e!==null&&(e.style.display="block",new Chart(document.getElementById("line-chart"),{type:"line",data:{labels:xAxisChartData,datasets:[{data:yAxisChartData,label:"Elevation",borderColor:"#fcba03",fill:!0}]},options:{title:{display:!0,text:"Elevation Profile"},scales:{xAxes:[{display:!0}]}}}))}function setupRouteIcons(n,t,i,r){let u=L.icon({iconUrl:"/images/map/startIcon.svg",iconSize:[32,37],iconAnchor:[1,37],popupAnchor:[5,-28]}),f=L.marker(n,{icon:u}).bindPopup("Start Location"),e=L.icon({iconUrl:"/images/map/finishIcon.svg",iconSize:[32,37],iconAnchor:[1,37],popupAnchor:[5,-28]}),o=L.marker(t,{icon:e}).bindPopup("Finish Location");r.addLayer(f);r.addLayer(o);editableLayers.addLayer(r);map.fitBounds(i.getBounds())}function handleRouteCreateFunc(n,t){document.getElementById("submitButton").addEventListener("click",async i=>{i.preventDefault();let f=document.getElementById("routeForm"),r=new FormData(f),e=r.get("Name"),o=r.get("StartLocation"),s=r.get("FinishLocation"),h=new Proxy(new URLSearchParams(window.location.search),{get:(n,t)=>n.get(t)}),u=h.forEventId;if(u===null){alert("Event does not exist.");return}showSpinner();await fetch("/Route/Create",{method:"post",headers:{"Content-Type":"application/json",RequestVerificationToken:`${n}`},body:JSON.stringify({creatorId:t,eventId:u,name:e,startLocationName:o,finishLocationName:s,routePoints:isUploadButtonClicked?importedRoutePoints:drawnRoutePoints,length:isUploadButtonClicked?importedRouteTotalLength:drawnRouteTotalLength,minimumAltitude:isUploadButtonClicked?minAltitude:0,maximumAltitude:isUploadButtonClicked?maxAltitude:0})}).then(n=>{hideSpinner(),n.ok?window.location=`/Event/Details?eventId=${u}`:n.status===400&&window.location.reload()}).catch(()=>{hideSpinner(),window.location.reload()})});let i=L.easyButton({states:[{icon:"fas fa-file-upload",title:"Plot GPX File",onClick:()=>{let n=document.getElementById("gpxFileUploadElement");n.value="";n.click();n.addEventListener("change",async n=>{n.stopImmediatePropagation();let t=n.target.files[0];isUploadButtonClicked=!0;drawImportedRoute(await processGPXAsync(t))})}}]});i.addTo(map)}let center=[42.6194,25.393],map=L.map("map",{fullscreenControl:!0,fullscreenControlOptions:{position:"topleft"},visualClick:!0,visualClickPane:"shadowPane"}).setView(center,7);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:'&copy; <a href="https://osm.org/copyright">OpenStreetMap<\/a> | &copy; <a href="https://opentopomap.org/about">OpenTopoMap<\/a> | &copy; <a href="/">Trails<\/a>'}).addTo(map);let editableLayers=new L.FeatureGroup;map.addLayer(editableLayers);let drawPluginOptions={position:"topleft",draw:{polyline:{shapeOptions:{color:"#c700ac",weight:4,smoothFactor:1,fillOpacity:.5}},polygon:!1,circle:!1,rectangle:!1,circlemarker:!1,marker:!1},edit:{featureGroup:editableLayers,edit:!1}};L.EditToolbar.Delete.include({enable:function(){this.options.featureGroup.clearLayers()}});let drawControl=new L.Control.Draw(drawPluginOptions);map.addControl(drawControl);L.control.mousePosition().addTo(map);L.control.scale().addTo(map);L.Control.Watermark=L.Control.extend({onAdd:function(){let n=L.DomUtil.create("img");return n.src="/images/map/watermark.png",n.style.width="130px",n}});L.control.watermark=function(n){return new L.Control.Watermark(n)};L.control.watermark({position:"topright"}).addTo(map);map.on(L.Draw.Event.CREATED,function(n){let t=n.layer;editableLayers.addLayer(t)});let drawnRoutePoints=[],drawnRouteTotalLength=0;map.on("draw:created",function(n){editableLayers.eachLayer(function(n){editableLayers.removeLayer(n)});isUploadButtonClicked=!1;drawnRoutePoints.length=0;drawnRouteTotalLength=0;document.getElementById("line-chart").style.display="none";let r=L.layerGroup();drawnRoutePoints=n.layer.getLatLngs().map(n=>[n.lat,n.lng]);let t=new L.Polyline(drawnRoutePoints,{color:"#c700ac",weight:4,smoothFactor:1,fillOpacity:.5}),i=n.layer.getLatLngs();for(let n=0;n<i.length-1;n++)drawnRouteTotalLength+=i[n].distanceTo(i[n+1]);drawnRouteTotalLength/=1e3;t.bindPopup(`Route for your event is ${drawnRouteTotalLength.toFixed(2)} kilometers long.`);r.addLayer(t);setupRouteIcons(drawnRoutePoints[0],drawnRoutePoints[drawnRoutePoints.length-1],t,r)});let importedRoutePoints=[],importedRouteTotalLength=0,minAltitude=0,maxAltitude=0,altitudes=[],yAxisChartData=[],xAxisChartData=[],isUploadButtonClicked=!1;